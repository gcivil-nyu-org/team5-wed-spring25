<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Restaurant Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- FontAwesome for custom icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #map {
            position: relative;
            padding-top: 300px;
            width: 100%;
            height: calc(100vh - 50px);
            left: 0;
            top: 0;
        }

        /* Custom FontAwesome Marker */
        .custom-dining-marker {
            text-align: center;
            line-height: 25px; /* Centers the icon */
        }

        .marker-icon {
            width: 30px;
            height: 30px;
            background-color: #ff5733; /* Default color */
            border-radius: 50%;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid black;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Initialize the Leaflet Map
        var map = L.map('map').setView([40.7128, -74.0060], 12);
    
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
    
        // Create a single global layer for markers
        window.markersLayer = L.layerGroup().addTo(map);
    
        // Function to create a custom FontAwesome dining icon
        function getDiningIcon(color) {
            return L.divIcon({
                className: "custom-dining-marker",
                html: `<div class="marker-icon" style="background-color: ${color};">
                           <i class="fa-solid fa-utensils"></i>
                       </div>`,
                iconSize: [30, 30], // Adjust size for visibility
                iconAnchor: [15, 30], // Align the marker properly
                popupAnchor: [0, -30] // Adjusts popup positioning
            });
        }
    
        // Function to determine marker color based on hygiene rating
        function getColorByRating(rating) {
            if (rating >= 28) return "#ff0000"; // Red for poor rating (8+)
            else if (rating >= 14) return "#ffa500"; // Orange for average (5-7)
            else return "#00cc00"; // Green for excellent (0-2)
        }
    
        // Function to update markers dynamically without reloading the map
        window.updateMarkers = function (data) {
            console.log("üó∫ Updating markers on the map...");
    
            // Clear old markers before adding new ones
            window.markersLayer.clearLayers();
    
            if (!data.features || data.features.length === 0) {
                console.warn("‚ö†Ô∏è No features found in response.");
                return;
            }
    
            // Add new markers based on GeoJSON data
            L.geoJSON(data, {
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(`
                        <b>${feature.properties.name}</b><br>
                        ${feature.properties.street}, Zipcode: ${feature.properties.zipcode}<br>
                        Hygiene Rating: ${feature.properties.hygiene_rating}
                    `);
                },
                pointToLayer: function (feature, latlng) {
                    const rating = feature.properties.hygiene_rating || 0;
                    const color = getColorByRating(rating);
                    return L.marker(latlng, { icon: getDiningIcon(color) });
                }
            }).addTo(window.markersLayer);
    
            console.log("‚úÖ Markers updated successfully!");
        };
    
        // Function to fetch data and update markers
        function updateMapData() {
            console.log("üîÑ Fetching initial restaurant data...");
            fetch('/api/restaurants/geojson/')
                .then(response => response.json())
                .then(data => {
                    console.log("üì• Received initial GeoJSON data");
                    updateMarkers(data);
                })
                .catch(error => console.error('‚ùå Error loading GeoJSON:', error));
        }
    
        // Reset to init state
        window.resetFilters = function () {
            console.log("üîÑ Resetting map to default state...");

            // Fetch all restaurant data without filters
            fetch('/api/restaurants/geojson/')
                .then(response => response.json())
                .then(data => {
                    console.log("‚úÖ Reset GeoJSON data received:", data);
                    window.updateMarkers(data);
                })
                .catch(error => console.error("‚ùå Error resetting map data:", error));
        };

        // Load initial data on page load
        updateMapData();
    </script>
  
</body>
</html>
