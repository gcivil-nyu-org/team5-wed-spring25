{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderator Profile - {{ moderator.first_name }} {{ moderator.last_name }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <style>
      html, body {
         margin: 0;
         padding: 0;
         height: 100%;
         overflow-y: auto;
         background-color: #ffedd3;
      }
      h1, h2 {
         color: #000;
         margin-bottom: 20px;
      }
      .main-body {
         padding: 15px;
      }
    </style>
</head>
<body>
    {% include 'components/header_nofilter.html' %}
    <div class="container" style="padding-top: 150px; background-color: #ffedd3;">
      <div class="main-body">
        <header class="mb-4">
          <h1>{{ moderator.username }}</h1>
        </header>
        
        <!-- Flagged Comments Card -->
        <div class="card mb-4">
          <div class="card-body">
            <h2 class="card-title">Flagged Comments</h2>
            {% if flagged_comments %}
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>Commenter</th>
                  <th>Comment</th>
                  <th>Posted at</th>
                  <th>Flagged by</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for comment in flagged_comments %}
                <tr>
                  <td>
                    <a href="{% url 'user_profile' comment.commenter.username %}">
                      {{ comment.commenter.username }}
                    </a>
                  </td>
                  <td>{{ comment.decoded_comment }}</td>
                  <td>{{ comment.posted_at }}</td>
                  <td>{{ comment.flagged_by.username }}</td>
                  <td>
                    <button type="button" class="btn btn-outline-danger deactivateBtn" data-userid="{{ comment.commenter.id }}">
                      Deactivate
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p>No flagged comments.</p>
            {% endif %}
          </div>
        </div>

        <!-- Flagged Direct Messages Card -->
        <div class="card mb-4">
          <div class="card-body">
            <h2 class="card-title">Flagged Direct Messages</h2>
            {% if flagged_dms %}
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>Sender</th>
                  <th>Message</th>
                  <th>Sent at</th>
                  <th>Flagged by</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for dm in flagged_dms %}
                <tr>
                  <td>
                    <a href="{% url 'user_profile' dm.sender.username %}">
                      {{ dm.sender.username }}
                    </a>
                  </td>
                  <td>{{ dm.decoded_message }}</td>
                  <td>{{ dm.sent_at }}</td>
                  <td>{{ dm.flagged_by.username }}</td>
                  <td>
                    <button type="button" class="btn btn-outline-danger deactivateBtn" data-userid="{{ dm.sender.id }}">
                      Deactivate
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p>No flagged direct messages.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Modal for deactivation reason -->
    <div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deactivateModalLabel">Deactivation Reason</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="deactivateForm" method="post" action="">
              {% csrf_token %}
              <input type="hidden" name="user_id" id="modalUserId" value="">
              <div class="mb-3">
                <textarea name="deactivation_reason" class="form-control" rows="4" placeholder="Enter the reason for deactivation..." required></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6zN8+zU5XbEVIe4IhZ9x2e3zZuX1po2lELKW/8XGSKhsXJp4cmM" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        var deactivateModalEl = document.getElementById('deactivateModal');
        var deactivateModal = new bootstrap.Modal(deactivateModalEl);
        
        var deactivateButtons = document.querySelectorAll(".deactivateBtn");
        deactivateButtons.forEach(function(btn) {
          btn.addEventListener("click", function() {
            var userId = btn.getAttribute("data-userid");
            // Set the user ID in the hidden input inside the modal
            document.getElementById("modalUserId").value = userId;
            // Set the form's action dynamically based on the user id
            document.getElementById("deactivateForm").action = "/deactivate_account/customer/" + userId + "/";
            // Show the modal
            deactivateModal.show();
          });
        });
      });
      function toggleDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.style.display = dropdown.style.display === 'flex' ? 'none' : 'flex';
      } 
    </script>
</body>
</html>
