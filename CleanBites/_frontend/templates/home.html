<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <title>Home</title>
  <link rel="stylesheet" href="{% static 'landing/css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'home/home.css' %}">
</head>
<body>

  <header class="apple-navbar">  
    <div class="navbar-left">
      <h2>CleanBites</h2>
    </div>

    <div class="search-bar">      
      <form id="search-form">
        <input type="text" id="search-name" placeholder="Restaurant Name">
        <input type="text" id="search-rating" placeholder="Hygiene Rating">
        <input type="text" id="search-cuisine" placeholder="Cuisine">
        <input type="text" id="search-distance" placeholder="Distance (km)">
        <button type="submit" class="search-btn">Search</button>
        <button type="button" class="reset-btn" onclick="resetMapInIframe()">Reset</button>
      </form>
    </div>

    <div class="navbar-right">
      <span class="username" style="color: rgb(231, 142, 0);">{{ user.username }}</span>
      <div class="profile-dropdown">
        <div class="avatar" onclick="toggleDropdown()">
          <!-- Placeholder avatar, WILL replace with user's profile image -->
          <img src="{% static 'images/avatar-placeholder.png' %}" alt="Profile" />
        </div>
        <div class="dropdown-menu" id="profileDropdown">
          <!-- WILL route HERE to user/restaurant profile page -->
          <a href="/home/" class="dropdown-item">Profile</a>
          <a href="/home/" class="dropdown-item">Messages</a>
          <a href="/home/" class="dropdown-item">Settings</a>
          <form method="POST" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="dropdown-item">Logout</button>
          </form>
        </div>
      </div>
    </div>    
  </header>

  <main>    
    <div class="geocode-wrapper">
      <button class="geocode-toggle" onclick="toggleGeocodeBar()">‚û§</button>
    
      <div class="geocode-bar hidden" id="geocode-bar">
        <input type="text" id="geocode-address" placeholder="Enter address to set map center" />
        <button type="button" onclick="submitGeocode()">Update Location</button>
        <span id="geocode-status" class="geocode-status"></span>
      </div>
    </div>
    
    <div id="map-container">
      <iframe id="map-frame" src="/mapdynamic/"></iframe>
      <div id="map-loading-spinner" style="display: none;">
        <div class="spinner"></div>
      </div>
    </div>
  </main>

  <script>    
    window.globalLAT = 40.69455789521935;
    window.globalLNG = -73.9865872293045;
    
    function toggleGeocodeBar() {
      const bar = document.getElementById('geocode-bar');
      bar.classList.toggle('hidden');
    }


    async function getCurrentGeocode(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

      try {
        const response = await fetch(url);
        const data = await response.json();
      
        if (data.length > 0) {
          const { lat, lon } = data[0];
          window.globalLAT = parseFloat(lat);
          window.globalLNG = parseFloat(lon);
          console.log("‚úÖ Updated global location:", window.globalLAT, window.globalLNG);
        } else {
          console.warn("‚ö†Ô∏è No results found for address.");
        }
      } catch (error) {
        console.error("‚ùå Error fetching geocode:", error);
      }
    }


    async function submitGeocode() {
      const address = document.getElementById('geocode-address').value;
      if (address.trim() === "") {
        alert("Please enter a valid address.");
        return;
      }
    
      await getCurrentGeocode(address);
      // Optionally center the map immediately if you want:
      if (window.map) {
        map.setView([window.globalLAT, window.globalLNG], 12);
      }

      setTimeout(() => {
        document.getElementById('geocode-status').textContent = '‚úÖ';
      }, 3);
    }
    

    window.onMapResetComplete = function () {
      document.getElementById('map-loading-spinner').style.display = 'none';
    };
    

    function toggleDropdown() {
      const dropdown = document.getElementById('profileDropdown');
      dropdown.style.display = dropdown.style.display === 'flex' ? 'none' : 'flex';
    }

    
    // Optional: Hide dropdown when clicking outside
    window.addEventListener('click', function(e) {
      const dropdown = document.getElementById('profileDropdown');
      if (!e.target.closest('.profile-dropdown')) {
        dropdown.style.display = 'none';
      }
    });


    function performSearch() {
      const name = document.getElementById('search-name').value;
      const rating = document.getElementById('search-rating').value;
      const cuisine = document.getElementById('search-cuisine').value;
      const distance = document.getElementById('search-distance').value;

      const lat = typeof window.globalLAT !== 'undefined' ? window.globalLAT : 40.69455789521935;
      const lng = typeof window.globalLNG !== 'undefined' ? window.globalLNG : -73.9865872293045;

      const params = new URLSearchParams({
        lat: lat,
        lng: lng,
        distance: distance,
        name: name,
        rating: rating,
        cuisine: cuisine
      });

      const apiUrl = `/api/restaurants/geojson/?${params.toString()}`;
      console.log("üì° Sending API request to:", apiUrl);

      document.getElementById('map-loading-spinner').style.display = 'flex';

      fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            // Get the iframe's contentWindow and pass data
            const mapFrame = document.getElementById("map-frame").contentWindow;
            if (mapFrame && mapFrame.updateMarkers) {
                mapFrame.updateMarkers(data);
            } else {
                console.error("‚ùå updateMarkers is not accessible in iframe!");
            }
        })
        .catch(error => console.error('‚ùå Error fetching restaurant data:', error))
        .finally(() => {
          document.getElementById('map-loading-spinner').style.display = 'none';
        });
    }


    function resetMapInIframe() {
      document.getElementById('search-name').value = "";
      document.getElementById('search-rating').value = "";
      document.getElementById('search-cuisine').value = "";
      document.getElementById('search-distance').value = "";

      document.getElementById('map-loading-spinner').style.display = 'flex';
      
      const mapFrame = document.getElementById("map-frame").contentWindow;
      if (mapFrame && typeof mapFrame.resetFilters === "function") {
          console.log("üîÑ Calling resetFilters inside iframe...");
          mapFrame.resetFilters();
      } else {
          console.error("‚ùå resetFilters is not accessible in iframe!");
      }
    }


    document.getElementById('search-form').addEventListener('submit', function (e) {
      e.preventDefault(); 
      performSearch();    
    });
  </script>

</body>
</html>
